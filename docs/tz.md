# ТЗ (предварительное) — Sinara (cinara.ru): методики + онлайн-уроки + ДЗ

**Версия:** 0.3  
**Дата:** 2026-02-10  
**Стек:** Next.js (App Router) / Tailwind / shadcn/ui / Supabase (Auth + Postgres + Storage + Edge Functions)  
**Оплата:** YooKassa или PayAnyWay (РФ), рекуррентные платежи/автоплатежи :contentReference[oaicite:0]{index=0}

---

## 1) Суть продукта

Sinara — SaaS для учителей и школ: продажа подписки на доступ к **методикам преподавания китайского языка** + инструменты проведения онлайн-уроков, выдачи ДЗ и контроля прогресса.

Ключевые принципы:
- **Методика (teacher-only)** — контент только для преподавателя (план, материалы для проведения урока).
- **Ученик** не покупает подписку и не видит методики/уроки напрямую — он видит:
  - расписание занятий (онлайн-уроки),
  - выданные домашние задания,
  - сообщения,
  - прогресс и словарь.
- **Онлайн-урок** проходит на платформе (встроенный видеозвонок “как Zoom”).

---

## 2) Роли и “школа” без сложных ролей

### 2.1 Роли (упрощённо)
- **Гость**
- **Учитель**
- **Ученик**
- **Админ платформы** (внутренний)

> “Школа” реализуется не отдельной ролью, а как **Workspace/Организация**: любой учитель может создать её, пригласить других учителей и оплатить план на места.

### 2.2 Workspace/Организация (школа)
**Workspace** — контейнер для:
- подписки (план + количество мест/seat_limit),
- списка учителей-участников.

Минимальный интерфейс (без тяжёлой админки):
- **Настройки → Команда**
  - создать Workspace (“Моя школа”)
  - пригласить преподавателя по email (инвайт)
  - список участников + роль в команде (Owner/Admin/Member)
  - счётчик мест: used/limit
- **Настройки → Оплата**
  - текущий план, дата окончания периода
  - “Купить/Продлить/Увеличить места” (на старте: 5 мест как готовый план)

Поведение мест:
- при принятии инвайта учителем — расходуется 1 место
- если мест нет — показать “Нужно докупить места/план”

---

## 3) Публичная часть (лендинг) и вход

### 3.1 Лендинг
При заходе на cinara.ru — landing page.

### 3.2 Вход (dropdown + модалка)
Кнопка **«Вход»** справа сверху:
- hover → dropdown:
  - “Вход”
  - “Ученик”
  - “Учитель”
- любой клик открывает модалку с 2 вкладками: **Ученик / Учитель**
- если клик по пункту dropdown — соответствующая вкладка предвыбрана

### 3.3 Регистрация
**Ученик:** телефон + email + пароль + имя  
**Учитель:** email + пароль + имя

---

## 4) Методики и уроки (teacher-only)

### 4.1 MVP контент
- 1 методика (начальные классы)
- 80 уроков

### 4.2 Что есть в уроке методики (для учителя)
Урок содержит:
- план/сценарий проведения (текст)
- материалы урока для преподавания:
  - презентация (обязательна, т.к. учитель ведёт по ней)
  - видео/аудио (если есть)
- шаблон ДЗ (см. раздел 7)

### 4.3 URL (учитель)
- методика: `/teacher/methodics/[methodicSlug]`
- урок: `/teacher/methodics/[methodicSlug]/lessons/[lessonNumberOrSlug]`

Ученик страниц методики/уроков **не видит**.

---

## 5) Доступ к методикам и защита контента

### 5.1 Планы
- Индивидуальный учитель: **990 ₽/мес**
- Workspace “Школа”: **3900 ₽/мес за 5 мест**

### 5.2 Paywall методик
- Учитель без активного доступа (нет личной подписки и не состоит в Workspace с активным plan):
  - видит методику,
  - полностью доступен только 1 урок,
  - остальные закрыты + CTA “Оформить подписку/план”.

### 5.3 Защита материалов (обязательно)
Цель: не делать материалы общедоступными и не позволять “просто переслать ссылку”.

Реализация:
- Supabase Storage: **private buckets**
- выдача доступа через **короткоживущие signed URL** (TTL 60–180 сек) после проверки прав (server action/edge function)
- логирование выдачи signed URL и rate-limit (минимально)
- для презентаций/медиа желательно отдавать через viewer/плеер без “прямой кнопки скачать”

Ограничение: 100% защита невозможна (скринрекорд), но пересылка ссылок становится бесполезной.

---

## 6) Онлайн-уроки (встроенный Zoom-подобный вебинар)

### 6.1 Что нужно
В системе должны быть **онлайн-уроки по расписанию**:
- учитель ↔ группа учеников или учитель ↔ ученик
- видеосвязь (камера/микрофон), чат
- **демонстрация экрана** (учитель)
- учитель может показывать презентацию урока (через демонстрацию окна/вкладки или встроенный режим)

### 6.2 Технический вариант (рекомендуемый для MVP)
**Встраивание готового WebRTC-решения** в страницу приложения:
- Вариант A (самый быстрый MVP): **Jitsi Meet IFrame API** (можно self-host) :contentReference[oaicite:1]{index=1}  
- Вариант B (больше контроля/сложнее): LiveKit self-host (SFU) :contentReference[oaicite:2]{index=2}

Для ТЗ фиксируем: **MVP = Jitsi IFrame API**, с возможностью перейти на LiveKit позже.

Требования к интеграции звонка:
- “Комната” создаётся автоматически для каждого занятия
- доступ к комнате только участникам занятия (teacher + assigned students)
- ссылка на занятие ведёт на внутренний роут `/classrooms/[sessionId]`, где рендерится встроенный звонок
- учитель может запускать занятие и завершать

*(Если потребуется “настоящий вебинар” 50+ участников — это отдельная оптимизация и выбор SFU/провайдера.)*

---

## 7) Домашние задания (ДЗ): шаблон из методики + индивидуальные настройки

### 7.1 Шаблон ДЗ внутри методики
У каждого урока есть **homework_template**, который задаёт:
- видео: N просмотров
- аудио: N прослушиваний
- презентация: требования (см. 8.4)
- текстовое задание (опционально)
- словарь/слова урока (см. 10)

### 7.2 Выдача ДЗ учителем
После онлайн-урока учитель выдаёт ДЗ:
- одному ученику или группе
- по умолчанию берётся шаблон ДЗ урока
- учитель может:
  - выставить **разное количество повторений** разным ученикам
  - добавить индивидуальный комментарий
  - добавить/изменить текст-задание (MVP: поле “доп. задание”)

### 7.3 Что видит ученик
Ученик видит только:
- список ДЗ
- детали ДЗ (что сделать, прогресс)
- словарь/карточки, если они включены в ДЗ
- сообщения
- расписание занятий

---

## 8) Трекинг выполнения ДЗ (античит)

### 8.1 Общая логика
Система пишет события взаимодействия ученика с материалами ДЗ и считает прогресс выполнения.

### 8.2 Видео
1 просмотр засчитывается, если:
- play стартовал
- просмотрено ≥ 80% длительности (порог настраиваемый)

### 8.3 Аудио
1 прослушивание засчитывается, если:
- play стартовал
- прослушано ≥ 80% длительности (порог настраиваемый)

### 8.4 Презентация (строго)
Требования:
- презентация должна быть пролистана до конца
- фиксировать время по каждому слайду
- античит-правила (настраиваемые):
  - минимум времени на слайд (например 2–3 сек для коротких)
  - или минимум суммарного времени

Рекомендуемая реализация:
- презентация как PDF, показ через viewer (pdf.js)
- события: `slide_enter`, `slide_leave`, `duration_ms`
- “выполнено”, если:
  - достигнут последний слайд
  - выполнены пороги по времени

### 8.5 Текстовое задание
Если требуется “написать”:
- ученик отправляет текст
- ДЗ не считается выполненным, пока текст не отправлен (если включено)
- (опционально позже) учитель отмечает “принято/не принято”

---

## 9) Расписание (календарь занятий)

### 9.1 Требования
У учителя должно быть расписание, чтобы планировать уроки:
- создавать занятие для группы или ученика
- выбирать дату/время, длительность
- привязывать занятие к уроку методики (lesson_id)
- у учеников в кабинете отображается:
  - ближайшие занятия
  - список занятий
  - кнопка “Присоединиться” (в момент занятия)

### 9.2 События и нотификации (MVP минимум)
- отображение в кабинете
- (опционально) email/смс уведомления позже

---

## 10) Словарь и карточки (300 слов на курс)

### 10.1 Контент
- В первой методике: **~300 слов**
- Слова распределены по урокам (в каждом уроке свой набор)

Каждое слово хранит:
- написание (иероглиф/пиньинь/перевод — по модели)
- **аудио произношения** (обязательно)

### 10.2 Тренажёр в ДЗ (обязательное правило)
Для каждого урока в ДЗ может быть включён тренажёр “Угадай слово”:
- ученику проигрывается **аудио слова**
- на экране карточки (варианты), ученик кликает/тапает правильную
- пока ученик не угадает **все слова набора** — ДЗ по словарю не выполнено

Минимальная механика (MVP):
- для каждого слова:
  - 1 попытка до правильного ответа (ошибки фиксируются)
  - варианты 4–6 карточек (1 правильная + случайные “дистракторы”)
- критерий “выполнено”:
  - все слова урока отмечены как угаданные (в рамках попытки/сессии ДЗ)

### 10.3 Личный словарь ученика
В кабинете ученика есть “Словарь”:
- все слова курса
- статус по каждому слову:
  - не начато / в изучении / выучено
- после угадывания слов урока они “падают в копилку” изученных (как минимум — отметка “пройдено в уроке”)

*(Spaced repetition/повторение по интервалам — можно в Phase 2.)*

---

## 11) Редактирование урока учителем + откат

### 11.1 Редактирование плана урока
Учитель может:
- отредактировать текст плана урока (teacher-only контент) “для себя”
- изменения сохраняются как **override** (не меняют базовую методику)
- кнопка “Сбросить к оригиналу” откатывает override и показывает исходный текст

### 11.2 Редактирование с помощью ИИ
В интерфейсе урока:
- кнопка “Изменить с помощью ИИ”
- учитель вводит запрос (например: “Добавь дополнительные упражнения, упростить объяснение”)
- система генерирует предложенную версию плана (preview)
- учитель принимает/отклоняет
- принятая версия сохраняется как override

Требования:
- хранить историю версий (минимум 5 последних) или хотя бы “последняя + оригинал”
- возможность отката к любой сохранённой версии (если включаем историю)

---

## 12) Сообщения (двусторонние)

- Учитель пишет ученику или группе
- Ученик отвечает учителю
- Формат: диалог (conversation) между teacher↔student, и отдельный тред для group-рассылок (по решению)

---

## 13) Оплата (YooKassa / PayAnyWay)

### 13.1 Рекуррентные платежи
Требования:
- оформление подписки (первый платёж + согласие на автосписания)
- webhooks → обновление статусов подписки
- хранение provider IDs и даты окончания периода

ЮKassa поддерживает автоплатежи через API (recurrent/recurring) :contentReference[oaicite:3]{index=3}.  
PayAnyWay указывает поддержку рекуррентных платежей :contentReference[oaicite:4]{index=4}.

---

## 14) Админка (простая)

Админка платформы:
- CRUD методик/уроков
- загрузка и привязка материалов (презентации/аудио/видео)
- CRUD словаря (слова, аудио, привязка к урокам)
- управление homework_template уроков
- просмотр пользователей/Workspace/подписок (минимально)

---

## 15) Предложение по модели данных (добавления к предыдущей)

### 15.1 Workspaces
`workspaces`
- id, title, owner_user_id, created_at

`workspace_members`
- workspace_id, user_id, role (owner|admin|member), created_at

`subscriptions`
- id, owner_type (workspace|teacher_personal), owner_id
- plan (teacher_990|workspace_3900_5)
- seat_limit, status, provider, provider_subscription_id, current_period_end

### 15.2 Расписание и занятия
`class_sessions`
- id
- workspace_id
- teacher_id
- lesson_id (nullable)
- starts_at, duration_min
- target_type (student|group)
- target_id (student_id/group_id)
- meeting_provider (jitsi|livekit)
- meeting_room_key
- status (scheduled|live|finished|canceled)

### 15.3 Словарь
`words`
- id
- hanzi / pinyin / ru_translation (поля уточняются)
- audio_path (private storage)
- created_at

`lesson_words`
- lesson_id
- word_id
- order_index

`student_word_progress`
- student_id
- word_id
- status (new|learning|learned)
- correct_count
- wrong_count
- last_seen_at

### 15.4 Override уроков учителя
`lesson_overrides`
- teacher_id
- lesson_id
- content_md_override
- created_at
- updated_at

(опционально) `lesson_override_versions`
- override_id
- content_md
- created_at
- source (manual|ai)

---

## 16) MVP Scope (обновление)

### Must-have
- Лендинг + вход dropdown + модалка (вкладки)
- Учитель/Ученик кабинеты (разные интерфейсы)
- Методика 1 / 80 уроков (teacher-only) + paywall
- Защита материалов (private storage + signed URLs)
- Ученики/группы + добавление по email/телефону + инвайт-ссылка
- Выдача ДЗ (из шаблона методики) + индивидуальные overrides
- Трекинг видео/аудио/презентации (время по слайдам)
- **Словарь/карточки** в ДЗ (аудио → выбрать слово)
- **Расписание**: занятия + отображение у ученика + кнопка “присоединиться”
- **Онлайн-урок в браузере** (MVP через Jitsi IFrame API) :contentReference[oaicite:5]{index=5}
- Сообщения (двусторонние)
- Оплата (YooKassa/PayAnyWay) + webhooks статусов :contentReference[oaicite:6]{index=6}
- Workspace/“Школа” (план на 5 мест) с минимальным UI (Команда/Оплата)

### Should-have
- История версий override урока
- Уведомления о занятиях (email)

---

## 17) Критерии приёмки (дополнено)

1) Ученик видит расписание занятий и может зайти в онлайн-урок по кнопке.  
2) Учитель может создать занятие для группы/ученика, привязать lesson_id, и начать видеозвонок со screen share.  
3) ДЗ формируется из шаблона урока, учитель может изменить требования индивидуально.  
4) Презентация ДЗ считается выполненной только при достижении последнего слайда + трекинг времени по слайдам.  
5) Словарь: ученик слушает аудио и выбирает карточку; пока все слова урока не угаданы — ДЗ по словам не выполнено.  
6) Учитель может редактировать план урока (override) и откатить к оригиналу; ИИ-редактирование предлагает вариант и сохраняется после подтверждения.

---

## 18) Размещение файла в репозитории
- `docs/tz.md` — это ТЗ
- `docs/roadmap.md` — этапы
- `docs/db-schema.md` — схема БД (после фиксации)
